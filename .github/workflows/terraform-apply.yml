name: Terraform Apply

# Applies Terraform changes after manual approval
on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to apply'
        required: false
        type: choice
        default: current-state
        options:
          - current-state
          - hetzner

# Only one apply at a time
concurrency:
  group: terraform-apply
  cancel-in-progress: false

permissions:
  contents: read
  issues: write
  id-token: write

jobs:
  detect-changes:
    name: Detect Changed Environments
    runs-on: ubuntu-latest
    outputs:
      current-state: ${{ steps.changes.outputs.current-state }}
      hetzner: ${{ steps.changes.outputs.hetzner }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - run selected environment
            SELECTED="${{ github.event.inputs.environment }}"
            if [ "$SELECTED" == "current-state" ]; then
              echo "current-state=true" >> $GITHUB_OUTPUT
              echo "hetzner=false" >> $GITHUB_OUTPUT
            elif [ "$SELECTED" == "hetzner" ]; then
              echo "current-state=false" >> $GITHUB_OUTPUT
              echo "hetzner=true" >> $GITHUB_OUTPUT
            fi
          else
            # Automatic trigger - check changed files
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})

            # current-state: environment files OR shared modules OR composite actions
            if echo "$CHANGED_FILES" | grep -q "terraform/environments/current-state/\|terraform/modules/\|\.github/actions/"; then
              echo "current-state=true" >> $GITHUB_OUTPUT
            else
              echo "current-state=false" >> $GITHUB_OUTPUT
            fi

            # hetzner: environment files OR composite actions
            if echo "$CHANGED_FILES" | grep -q "terraform/environments/hetzner/\|\.github/actions/"; then
              echo "hetzner=true" >> $GITHUB_OUTPUT
            else
              echo "hetzner=false" >> $GITHUB_OUTPUT
            fi
          fi

  apply-current-state:
    name: Apply - Current State
    needs: detect-changes
    if: needs.detect-changes.outputs.current-state == 'true'
    runs-on: self-hosted
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    defaults:
      run:
        working-directory: terraform/environments/current-state

    steps:
      - name: Terraform Setup
        id: setup
        uses: ./.github/actions/terraform-setup
        with:
          vault-addr: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
          vault-secrets: |
            secret/data/prod/infrastructure/proxmox api_endpoint | PROXMOX_API_ENDPOINT ;
            secret/data/prod/infrastructure/proxmox api_token_id | PROXMOX_API_TOKEN_ID ;
            secret/data/prod/infrastructure/proxmox api_token_secret | PROXMOX_API_TOKEN_SECRET ;
            secret/data/shared/ssh public_keys | SSH_PUBLIC_KEYS ;
            secret/data/shared/ci-cd/aws role_arn | AWS_ROLE_ARN
          working-directory: terraform/environments/current-state
          terraform-wrapper: 'false'
          run-fmt: 'false'
          run-validate: 'false'

      - name: Terraform Plan
        id: plan
        run: |
          set -o pipefail
          terraform plan -out=tfplan -no-color | tee plan_output.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        env:
          TF_VAR_proxmox_api_url: ${{ env.PROXMOX_API_ENDPOINT }}
          TF_VAR_proxmox_api_token_id: ${{ env.PROXMOX_API_TOKEN_ID }}
          TF_VAR_proxmox_api_token_secret: ${{ env.PROXMOX_API_TOKEN_SECRET }}
          TF_VAR_ssh_public_keys: ${{ env.SSH_PUBLIC_KEYS }}

      - name: Check for Changes
        id: check
        run: |
          if grep -q "No changes" plan_output.txt; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes to apply"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes found, executing apply"
          fi

      - name: Terraform Apply
        id: apply
        if: steps.check.outputs.changes == 'true'
        run: |
          set -o pipefail
          terraform apply -auto-approve tfplan | tee apply_output.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        env:
          TF_VAR_proxmox_api_url: ${{ env.PROXMOX_API_ENDPOINT }}
          TF_VAR_proxmox_api_token_id: ${{ env.PROXMOX_API_TOKEN_ID }}
          TF_VAR_proxmox_api_token_secret: ${{ env.PROXMOX_API_TOKEN_SECRET }}
          TF_VAR_ssh_public_keys: ${{ env.SSH_PUBLIC_KEYS }}

      - name: Create Apply Summary
        if: always()
        run: |
          echo "### Terraform Apply - Current State" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** current-state" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.apply.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changes:** ${{ steps.check.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f apply_output.txt ]; then
            echo "<details><summary>Apply Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat apply_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Apply Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: current-state-apply-${{ github.run_number }}
          path: |
            terraform/environments/current-state/plan_output.txt
            terraform/environments/current-state/apply_output.txt
          retention-days: 90

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let applyOutput = 'Apply output not available';
            try {
              applyOutput = fs.readFileSync('terraform/environments/current-state/apply_output.txt', 'utf8');
            } catch (error) {
              console.log('Apply output could not be read');
            }

            const body = `## Terraform Apply Failed - Current State

            **Environment:** current-state

            **Workflow:** [Run #${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Commit:** ${context.sha.substring(0, 7)}
            **Triggered by:** @${context.actor}

            ### Error Output

            \`\`\`
            ${applyOutput.length > 60000 ? applyOutput.substring(0, 60000) + '\n\n... (Output truncated)' : applyOutput}
            \`\`\`

            ### Action Required

            Terraform Apply failed. Please check:
            1. Logs in the Workflow Run
            2. Terraform State Status
            3. Proxmox API Accessibility
            4. Resource Configuration

            **IMPORTANT:** Manual intervention required!`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Terraform Apply failed - current-state',
              body: body,
              labels: ['terraform', 'apply-failure', 'current-state', 'urgent']
            });

      - name: Fail Job if Apply Failed
        if: steps.apply.outcome == 'failure'
        run: exit 1

  apply-hetzner:
    name: Apply - Hetzner
    needs: detect-changes
    if: needs.detect-changes.outputs.hetzner == 'true'
    runs-on: ubuntu-latest
    environment:
      name: hetzner-production
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    defaults:
      run:
        working-directory: terraform/environments/hetzner

    steps:
      - name: Terraform Setup
        id: setup
        uses: ./.github/actions/terraform-setup
        with:
          vault-addr: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
          vault-secrets: |
            secret/data/prod/infrastructure/hetzner api_token | HCLOUD_TOKEN ;
            secret/data/shared/backup/hetzner-storagebox-main password | STORAGE_BOX_PASSWORD ;
            secret/data/shared/ci-cd/aws role_arn | AWS_ROLE_ARN
          working-directory: terraform/environments/hetzner
          terraform-wrapper: 'false'
          run-fmt: 'false'
          run-validate: 'false'

      - name: Terraform Plan
        id: plan
        run: |
          set -o pipefail
          terraform plan -out=tfplan -no-color | tee plan_output.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        env:
          TF_VAR_hcloud_token: ${{ env.HCLOUD_TOKEN }}
          TF_VAR_storage_box_password: ${{ env.STORAGE_BOX_PASSWORD }}

      - name: Check for Changes
        id: check
        run: |
          if grep -q "No changes" plan_output.txt; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes to apply"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes found, executing apply"
          fi

      - name: Terraform Apply
        id: apply
        if: steps.check.outputs.changes == 'true'
        run: |
          set -o pipefail
          terraform apply -auto-approve tfplan | tee apply_output.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        env:
          TF_VAR_hcloud_token: ${{ env.HCLOUD_TOKEN }}
          TF_VAR_storage_box_password: ${{ env.STORAGE_BOX_PASSWORD }}

      - name: Create Apply Summary
        if: always()
        run: |
          echo "### Terraform Apply - Hetzner" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** hetzner" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.apply.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changes:** ${{ steps.check.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f apply_output.txt ]; then
            echo "<details><summary>Apply Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat apply_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Apply Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hetzner-apply-${{ github.run_number }}
          path: |
            terraform/environments/hetzner/plan_output.txt
            terraform/environments/hetzner/apply_output.txt
          retention-days: 90

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let applyOutput = 'Apply output not available';
            try {
              applyOutput = fs.readFileSync('terraform/environments/hetzner/apply_output.txt', 'utf8');
            } catch (error) {
              console.log('Apply output could not be read');
            }

            const body = `## Terraform Apply Failed - Hetzner

            **Environment:** hetzner

            **Workflow:** [Run #${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Commit:** ${context.sha.substring(0, 7)}
            **Triggered by:** @${context.actor}

            ### Error Output

            \`\`\`
            ${applyOutput.length > 60000 ? applyOutput.substring(0, 60000) + '\n\n... (Output truncated)' : applyOutput}
            \`\`\`

            ### Action Required

            Terraform Apply failed. Please check:
            1. Logs in the Workflow Run
            2. Terraform State Status
            3. Hetzner Cloud API Accessibility
            4. Resource Configuration

            **IMPORTANT:** Manual intervention required!`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Terraform Apply failed - hetzner',
              body: body,
              labels: ['terraform', 'apply-failure', 'hetzner', 'urgent']
            });

      - name: Fail Job if Apply Failed
        if: steps.apply.outcome == 'failure'
        run: exit 1


  notify-completion:
    name: Notify Completion
    needs: [apply-current-state, apply-hetzner]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check Results
        run: |
          echo "Apply workflow completed"
          echo "Current State: ${{ needs.apply-current-state.result }}"
          echo "Hetzner: ${{ needs.apply-hetzner.result }}"

          FAILED=false
          if [ "${{ needs.apply-current-state.result }}" == "failure" ]; then
            echo "Current State apply failed"
            FAILED=true
          fi
          if [ "${{ needs.apply-hetzner.result }}" == "failure" ]; then
            echo "Hetzner apply failed"
            FAILED=true
          fi

          if [ "$FAILED" == "true" ]; then
            exit 1
          fi
