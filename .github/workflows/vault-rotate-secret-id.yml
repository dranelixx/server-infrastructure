name: Vault Secret ID Rotation

# Rotates the AppRole Secret ID weekly to limit exposure window
on:
  schedule:
    - cron: '0 4 * * 1' # Every Monday 04:00 UTC
  workflow_dispatch: # Manual trigger

# Only one rotation at a time
concurrency:
  group: vault-rotate-secret-id
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

jobs:
  rotate:
    name: Rotate Secret ID
    runs-on: self-hosted

    steps:
      - name: Generate new Secret ID
        id: rotate
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_ROLE_ID: ${{ secrets.VAULT_ROLE_ID }}
          VAULT_SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}
        run: |
          # Authenticate with current Secret ID
          LOGIN_RESPONSE=$(curl -sf "$VAULT_ADDR/v1/auth/approle/login" \
            -X POST \
            -d "{\"role_id\":\"$VAULT_ROLE_ID\",\"secret_id\":\"$VAULT_SECRET_ID\"}")

          VAULT_TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.auth.client_token')
          if [ -z "$VAULT_TOKEN" ] || [ "$VAULT_TOKEN" = "null" ]; then
            echo "::error::Failed to authenticate with Vault"
            exit 1
          fi

          # Generate new Secret ID
          SECRET_RESPONSE=$(curl -sf "$VAULT_ADDR/v1/auth/approle/role/github-actions/secret-id" \
            -X POST \
            -H "X-Vault-Token: $VAULT_TOKEN")

          NEW_SECRET_ID=$(echo "$SECRET_RESPONSE" | jq -r '.data.secret_id')
          if [ -z "$NEW_SECRET_ID" ] || [ "$NEW_SECRET_ID" = "null" ]; then
            echo "::error::Failed to generate new Secret ID"
            exit 1
          fi

          # Mask in logs
          echo "::add-mask::$NEW_SECRET_ID"

          # Pass to next step via file (not env, to avoid log exposure)
          echo "$NEW_SECRET_ID" > /tmp/new_secret_id
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Update GitHub Secret
        if: steps.rotate.outputs.success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_SECRETS }}
        run: |
          gh secret set VAULT_SECRET_ID --repo "$GITHUB_REPOSITORY" < /tmp/new_secret_id
          rm -f /tmp/new_secret_id
          echo "Secret ID rotated successfully"

      - name: Cleanup on failure
        if: failure()
        run: rm -f /tmp/new_secret_id

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'vault,secret-rotation'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Vault Secret ID rotation failed',
                body: `Secret ID rotation failed. Manual intervention required.\n\n` +
                  `**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n` +
                  `### Manual rotation steps\n` +
                  `1. \`vault write -f auth/approle/role/github-actions/secret-id\`\n` +
                  `2. \`gh secret set VAULT_SECRET_ID\` â†’ paste new Secret ID\n`,
                labels: ['vault', 'secret-rotation', 'urgent']
              });
            }
