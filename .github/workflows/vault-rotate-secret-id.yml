name: Vault Secret ID Rotation

# Rotates the AppRole Secret ID weekly to limit exposure window
on:
  schedule:
    - cron: '0 4 * * 1' # Every Monday 04:00 UTC
  workflow_dispatch: # Manual trigger

# Only one rotation at a time
concurrency:
  group: vault-rotate-secret-id
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

jobs:
  rotate:
    name: Rotate Secret ID
    runs-on: self-hosted

    steps:
      - name: Setup CLI tools
        run: |
          NEED_UPDATE=false

          ARCH=$(dpkg --print-architecture)
          CODENAME=$(lsb_release -cs)

          if ! command -v gh &> /dev/null; then
            GPG=/usr/share/keyrings/githubcli-archive-keyring.gpg
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
              | sudo dd of=$GPG 2>/dev/null
            echo "deb [arch=$ARCH signed-by=$GPG] https://cli.github.com/packages stable main" \
              | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            NEED_UPDATE=true
          fi

          if ! command -v vault &> /dev/null; then
            GPG=/usr/share/keyrings/hashicorp-archive-keyring.gpg
            curl -fsSL https://apt.releases.hashicorp.com/gpg \
              | sudo gpg --dearmor -o $GPG 2>/dev/null
            echo "deb [arch=$ARCH signed-by=$GPG] https://apt.releases.hashicorp.com $CODENAME main" \
              | sudo tee /etc/apt/sources.list.d/hashicorp.list > /dev/null
            NEED_UPDATE=true
          fi

          if [ "$NEED_UPDATE" = true ]; then
            sudo apt-get update -qq && sudo apt-get install -y -qq gh vault
          fi

      - name: Generate new Secret ID
        id: rotate
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
        run: |
          # Authenticate with current Secret ID
          VAULT_TOKEN=$(vault write -field=token auth/approle/login \
            role_id="${{ secrets.VAULT_ROLE_ID }}" \
            secret_id="${{ secrets.VAULT_SECRET_ID }}")

          export VAULT_TOKEN

          # Generate new Secret ID
          NEW_SECRET_ID=$(vault write -field=secret_id \
            -f auth/approle/role/github-actions/secret-id)

          # Mask in logs
          echo "::add-mask::$NEW_SECRET_ID"

          # Pass to next step via file (not env, to avoid log exposure)
          echo "$NEW_SECRET_ID" > /tmp/new_secret_id
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Update GitHub Secret
        if: steps.rotate.outputs.success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_SECRETS }}
        run: |
          gh secret set VAULT_SECRET_ID --repo "$GITHUB_REPOSITORY" < /tmp/new_secret_id
          rm -f /tmp/new_secret_id
          echo "Secret ID rotated successfully"

      - name: Cleanup on failure
        if: failure()
        run: rm -f /tmp/new_secret_id

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'vault,secret-rotation'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Vault Secret ID rotation failed',
                body: `Secret ID rotation failed. Manual intervention required.\n\n` +
                  `**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n` +
                  `### Manual rotation steps\n` +
                  `1. \`vault write -f auth/approle/role/github-actions/secret-id\`\n` +
                  `2. \`gh secret set VAULT_SECRET_ID\` â†’ paste new Secret ID\n`,
                labels: ['vault', 'secret-rotation', 'urgent']
              });
            }
