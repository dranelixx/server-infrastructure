---
# SSH key tasks for Proxmox Backup role

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "{{ pve_backup_ssh_key_path | dirname }}"
    state: directory
    mode: "0700"
    owner: root
    group: root

- name: Generate SSH key for backup
  community.crypto.openssh_keypair:
    path: "{{ pve_backup_ssh_key_path }}"
    type: ed25519
    comment: "root@{{ inventory_hostname }}"
    state: present
  register: ssh_key_generated
  when: pve_backup_ssh_key_generate | bool

- name: Read generated SSH public key
  ansible.builtin.slurp:
    src: "{{ pve_backup_ssh_key_path }}.pub"
  register: ssh_pubkey_content
  when:
    - pve_backup_ssh_key_generate | bool
    - ssh_key_generated.changed

- name: Display SSH public key for manual installation
  ansible.builtin.debug:
    msg:
      - "SSH key generated. Add this public key to your Storage Box:"
      - ""
      - "{{ ssh_pubkey_content.content | b64decode | trim }}"
      - ""
      - "Command: cat {{ pve_backup_ssh_key_path }}.pub | ssh -p {{ pve_backup_remote_port }} {{ pve_backup_remote_user }}@{{ pve_backup_remote_host }} install-ssh-key"
  when:
    - pve_backup_ssh_key_generate | bool
    - ssh_key_generated.changed

- name: Fetch host key from Storage Box
  ansible.builtin.command:
    cmd: "ssh-keyscan -p {{ pve_backup_remote_port }} {{ pve_backup_remote_host }}"
  register: ssh_keyscan_result
  changed_when: false
  failed_when: ssh_keyscan_result.rc != 0 or ssh_keyscan_result.stdout | length == 0

- name: Add Storage Box to known_hosts
  ansible.builtin.known_hosts:
    name: "[{{ pve_backup_remote_host }}]:{{ pve_backup_remote_port }}"
    key: "{{ ssh_keyscan_result.stdout }}"
    path: /root/.ssh/known_hosts
    state: present
