#!/bin/bash
# {{ ansible_managed }}
# Proxmox configuration backup script
# Deployed by Ansible role: proxmox-backup
set -euo pipefail

REMOTE="{{ pve_backup_remote_user }}@{{ pve_backup_remote_host }}"
REMOTE_PATH="{{ pve_backup_remote_path }}"
SSH_KEY="{{ pve_backup_ssh_key_path }}"
SSH_PORT="{{ pve_backup_remote_port }}"
DATE=$(date +%Y-%m-%d)
HOSTNAME=$(hostname)
RETENTION_DAYS={{ pve_backup_retention_days }}

{% if pve_backup_ntfy_enabled %}
# ntfy notification settings
NTFY_URL="{{ pve_backup_ntfy_url }}"
NTFY_TOKEN="{{ pve_backup_ntfy_token }}"
{% endif %}

notify() {
  local msg="$1"
  local priority="${2:-default}"
{% if pve_backup_ntfy_enabled %}
  if [ -n "$NTFY_TOKEN" ] && [ -n "$NTFY_URL" ]; then
    curl -s -H "Authorization: Bearer $NTFY_TOKEN" \
         -H "Priority: $priority" \
         -d "$msg" "$NTFY_URL" || true
  fi
{% else %}
  # ntfy disabled - notification is a no-op
  :
{% endif %}
}

# Sync configs to dated directory
if rsync -az --delete \
{% for exclude in pve_backup_excludes %}
  --exclude='{{ exclude }}' \
{% endfor %}
{% for path in pve_backup_paths %}
  {{ path }} \
{% endfor %}
  -e "ssh -p $SSH_PORT -i $SSH_KEY" \
  "$REMOTE:$REMOTE_PATH/$DATE/"; then

  # Keep only last N days
  ssh -p "$SSH_PORT" -i "$SSH_KEY" "$REMOTE" \
    "cd $REMOTE_PATH && ls -d */ 2>/dev/null | sort | head -n -${RETENTION_DAYS} | xargs -r rm -rf" || true

  echo "$(date '+%Y-%m-%d %H:%M:%S') Backup completed: $DATE"
  notify "✅ $HOSTNAME config backup OK ($DATE)"
else
  echo "$(date '+%Y-%m-%d %H:%M:%S') Backup FAILED: $DATE"
  notify "❌ $HOSTNAME config backup FAILED!" "high"
  exit 1
fi
