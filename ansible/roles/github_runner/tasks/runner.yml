---
# GitHub Actions Runner installation tasks

- name: Check if runner is already installed
  ansible.builtin.stat:
    path: "{{ github_runner_home }}/bin/Runner.Listener"
  register: github_runner_installed
  tags:
    - runner

- name: Get latest GitHub Actions runner version
  ansible.builtin.uri:
    url: "https://api.github.com/repos/actions/runner/releases/latest"
    return_content: true
    timeout: 30
  register: github_runner_latest_release
  retries: 3
  delay: 10
  until: github_runner_latest_release.status == 200
  when: github_runner_version == "latest" and not github_runner_installed.stat.exists
  failed_when: false
  tags:
    - runner

- name: Use fallback runner version if API failed
  ansible.builtin.set_fact:
    github_runner_api_failed: "{{ github_runner_latest_release.status is not defined or github_runner_latest_release.status != 200 }}"
  when: github_runner_version == "latest" and not github_runner_installed.stat.exists
  tags:
    - runner

- name: Warn if using fallback version
  ansible.builtin.debug:
    msg: "WARNING: GitHub API unreachable. Using fallback runner version 2.331.0"
  when: github_runner_version == "latest" and not github_runner_installed.stat.exists and github_runner_api_failed
  tags:
    - runner

- name: Set runner version variable
  ansible.builtin.set_fact:
    github_runner_install_version: >-
      {{ github_runner_latest_release.json.tag_name | regex_replace('^v', '')
         if (github_runner_version == 'latest' and not github_runner_api_failed)
         else ('2.331.0' if github_runner_version == 'latest'
               else github_runner_version) }}
  when: not github_runner_installed.stat.exists
  tags:
    - runner

- name: Display runner installation status
  ansible.builtin.debug:
    msg: "GitHub Actions Runner is already installed at {{ github_runner_home }}"
  when: github_runner_installed.stat.exists
  tags:
    - runner

- name: Install GitHub Actions Runner
  when: not github_runner_installed.stat.exists
  block:
    - name: Create temporary directory for runner download
      ansible.builtin.tempfile:
        state: directory
        suffix: runner
      register: github_runner_temp_dir
      tags:
        - runner

    - name: Download GitHub Actions Runner
      vars:
        github_runner_download_base: "https://github.com/actions/runner/releases/download"
        github_runner_archive: "actions-runner-linux-x64-{{ github_runner_install_version }}.tar.gz"
      ansible.builtin.get_url:
        url: "{{ github_runner_download_base }}/v{{ github_runner_install_version }}/{{ github_runner_archive }}"
        dest: "{{ github_runner_temp_dir.path }}/actions-runner.tar.gz"
        mode: '0644'
        timeout: 300
      retries: 3
      delay: 10
      register: github_runner_download
      until: github_runner_download is succeeded
      tags:
        - runner

    - name: Extract GitHub Actions Runner
      ansible.builtin.unarchive:
        src: "{{ github_runner_temp_dir.path }}/actions-runner.tar.gz"
        dest: "{{ github_runner_home }}"
        remote_src: true
        owner: "{{ github_runner_user }}"
        group: "{{ github_runner_group }}"
      become: true
      tags:
        - runner

    - name: Remove temporary directory
      ansible.builtin.file:
        path: "{{ github_runner_temp_dir.path }}"
        state: absent
      tags:
        - runner

    - name: Set correct permissions on runner directory
      ansible.builtin.file:
        path: "{{ github_runner_home }}"
        state: directory
        owner: "{{ github_runner_user }}"
        group: "{{ github_runner_group }}"
        recurse: true
      become: true
      tags:
        - runner

    - name: Make runner scripts executable
      ansible.builtin.file:
        path: "{{ github_runner_home }}/{{ item }}"
        mode: '0755'
      become: true
      loop:
        - config.sh
        - run.sh
        - bin/Runner.Listener
        - bin/Runner.Worker
        - bin/Runner.PluginHost
      tags:
        - runner

- name: Create work directory
  ansible.builtin.file:
    path: "{{ github_runner_work_dir }}"
    state: directory
    owner: "{{ github_runner_user }}"
    group: "{{ github_runner_group }}"
    mode: '0755'
  become: true
  tags:
    - runner

- name: Create symlinks for node binaries
  ansible.builtin.file:
    src: "{{ github_runner_home }}/externals/node20/bin/{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    state: link
    force: true
  become: true
  loop:
    - node
    - npm
  tags:
    - runner

- name: Check runner version
  ansible.builtin.command: "{{ github_runner_home }}/bin/Runner.Listener --version"
  become: true
  become_user: "{{ github_runner_user }}"
  register: github_runner_version_output
  changed_when: false
  tags:
    - runner

- name: Display runner version
  ansible.builtin.debug:
    msg: "GitHub Actions Runner version: {{ github_runner_version_output.stdout }}"
  tags:
    - runner
