---
# Pre-flight checks for GitHub Actions Runner

- name: Check if running on Ubuntu
  ansible.builtin.assert:
    that:
      - ansible_distribution == "Ubuntu"
    fail_msg: "This role only supports Ubuntu. Detected: {{ ansible_distribution }}"
    success_msg: "Running on Ubuntu {{ ansible_distribution_version }}"
  tags:
    - preflight

- name: Check Ubuntu version is 20.04 or newer
  ansible.builtin.assert:
    that:
      - ansible_distribution_version is version('20.04', '>=')
    fail_msg: "Ubuntu 20.04 or newer required. Detected: {{ ansible_distribution_version }}"
    success_msg: "Ubuntu version {{ ansible_distribution_version }} is supported"
  tags:
    - preflight

- name: Check system architecture
  ansible.builtin.assert:
    that:
      - ansible_architecture == "x86_64"
    fail_msg: "Only x86_64 architecture is supported. Detected: {{ ansible_architecture }}"
    success_msg: "Architecture {{ ansible_architecture }} is supported"
  tags:
    - preflight

- name: Test network connectivity to Proxmox API
  ansible.builtin.wait_for:
    host: "{{ github_runner_proxmox_api_host }}"
    port: "{{ github_runner_proxmox_api_port }}"
    timeout: 10
    msg: "Cannot reach Proxmox API at {{ github_runner_proxmox_api_host }}:{{ github_runner_proxmox_api_port }}"
  tags:
    - preflight
    - network

- name: Test connectivity to GitHub
  ansible.builtin.uri:
    url: "https://api.github.com"
    method: GET
    timeout: 10
  register: github_runner_github_check
  failed_when: false
  changed_when: false
  tags:
    - preflight
    - network

- name: Warn if GitHub is unreachable
  ansible.builtin.debug:
    msg: "WARNING: GitHub API unreachable (Status: {{ github_runner_github_check.status | default('timeout') }}). Runner installation may fail."
  when: github_runner_github_check.status is not defined or github_runner_github_check.status != 200
  tags:
    - preflight
    - network

- name: Display pre-flight check results
  ansible.builtin.debug:
    msg:
      - "Pre-flight checks passed:"
      - "  - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
      - "  - Architecture: {{ ansible_architecture }}"
      - "  - Proxmox API: {{ github_runner_proxmox_api_host }}:{{ github_runner_proxmox_api_port }} ✓"
      - "  - GitHub API: Reachable ✓"
  tags:
    - preflight
