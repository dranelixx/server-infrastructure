---
# SSH key tasks for Proxmox Backup role

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "{{ proxmox_backup_ssh_key_path | dirname }}"
    state: directory
    mode: "0700"
    owner: root
    group: root

- name: Generate SSH key for backup
  community.crypto.openssh_keypair:
    path: "{{ proxmox_backup_ssh_key_path }}"
    type: ed25519
    comment: "root@{{ inventory_hostname }}"
    state: present
  register: proxmox_backup_ssh_key_generated
  when: proxmox_backup_ssh_key_generate | bool

- name: Read generated SSH public key
  ansible.builtin.slurp:
    src: "{{ proxmox_backup_ssh_key_path }}.pub"
  register: proxmox_backup_ssh_pubkey_content
  when:
    - proxmox_backup_ssh_key_generate | bool
    - proxmox_backup_ssh_key_generated.changed

- name: Display SSH public key for manual installation
  ansible.builtin.debug:
    msg:
      - "SSH key generated. Add this public key to your Storage Box:"
      - ""
      - "{{ proxmox_backup_ssh_pubkey_content.content | b64decode | trim }}"
      - ""
      - >-
        Command: cat {{ proxmox_backup_ssh_key_path }}.pub |
        ssh -p {{ proxmox_backup_remote_port }}
        {{ proxmox_backup_remote_user }}@{{ proxmox_backup_remote_host }}
        install-ssh-key
  when:
    - proxmox_backup_ssh_key_generate | bool
    - proxmox_backup_ssh_key_generated.changed

- name: Fetch host key from Storage Box
  ansible.builtin.command:
    cmd: "ssh-keyscan -p {{ proxmox_backup_remote_port }} {{ proxmox_backup_remote_host }}"
  register: proxmox_backup_ssh_keyscan_result
  changed_when: false
  failed_when: proxmox_backup_ssh_keyscan_result.rc != 0 or proxmox_backup_ssh_keyscan_result.stdout | length == 0

- name: Add Storage Box to known_hosts
  ansible.builtin.known_hosts:
    name: "[{{ proxmox_backup_remote_host }}]:{{ proxmox_backup_remote_port }}"
    key: "{{ proxmox_backup_ssh_keyscan_result.stdout }}"
    path: /root/.ssh/known_hosts
    state: present
