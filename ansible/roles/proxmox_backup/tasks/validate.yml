---
# Validation tasks for Proxmox Backup role

- name: Validate required variables are set
  ansible.builtin.assert:
    that:
      - proxmox_backup_remote_user | length > 0
      - proxmox_backup_remote_host | length > 0
    fail_msg: "Required variables proxmox_backup_remote_user and proxmox_backup_remote_host must be set"
    success_msg: "Required variables validated"

- name: Validate SSH key exists (if not generating)
  ansible.builtin.stat:
    path: "{{ proxmox_backup_ssh_key_path }}"
  register: proxmox_backup_ssh_key_stat
  when: not proxmox_backup_ssh_key_generate | bool

- name: Fail if SSH key doesn't exist and not generating
  ansible.builtin.fail:
    msg: "SSH key {{ proxmox_backup_ssh_key_path }} does not exist. Set proxmox_backup_ssh_key_generate: true or create key manually."
  when:
    - not proxmox_backup_ssh_key_generate | bool
    - not proxmox_backup_ssh_key_stat.stat.exists | default(false)

- name: Validate retention days is positive
  ansible.builtin.assert:
    that:
      - proxmox_backup_retention_days | int > 0
    fail_msg: "proxmox_backup_retention_days must be a positive integer"
